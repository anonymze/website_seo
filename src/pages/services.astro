---
import Layout from "@/layouts/layout.astro";
import { CalculatorIcon } from "lucide-react";

// Page SEO data
const pageData = {
    title: "Services - Yann Metier Création de Sites Web",
    description:
        "Découvrez mes services de création de sites web : sites vitrines, e-commerce ou corporate. Devis personnalisés et solutions sur-mesure.",
    keywords:
        "calculateur prix site internet, devis site web automatique, estimation coût création site, tarif développeur web freelance, services création sites professionnels France",
};

// Features data
const features = [
    {
        id: "responsive",
        label: "Site adapté mobile et tablette",
        price: 0,
        included: true,
    },
    {
        id: "seo",
        label: "Référencement Google de base",
        price: 0,
        included: true,
    },
    {
        id: "ai-design",
        label: "2 propositions de design selon vos préférences",
        price: 0,
        included: true,
    },
    {
        id: "hosting",
        label: "Hébergement en ligne sous un nom de domaine personnalisé (ex: mon-site-important.fr)",
        subscription: "60€ / an",
        included: true,
    },
    {
        id: "maintenance",
        label: "Maintenance et mises à jour",
        price: 0,
        special: "1ère année offerte",
        subscription: "150€ / an",
    },
    {
        id: "analytics",
        label: "Analytics et statistiques de trafics avancées",
        price: 100,
        included: false,
    },
    {
        id: "newsletter",
        label: "Envoi d'emails automatique (newsletter)",
        price: 100,
        subscription: "8€ / mois",
    },
    {
        id: "booking",
        label: "Prise de rendez-vous en ligne",
        price: 100,
        subscription: "10€ / mois",
    },
    { id: "multilang", label: "Site en plusieurs langues", price: 200 },
    { id: "payment", label: "Paiement en ligne sécurisé", price: 600 },
    {
        id: "dashboard",
        label: "Panneau d'administration avec espace client et / ou gestion de contenu",
        price: 600,
    },
    {
        id: "pro-design",
        label: "Design du site sur mesure (réalisé par un designer professionnel)",
        price: 1500,
        special: "À partir de 1500€ et dépendant de la complexité du projet",
    },
];
---

<Layout
    title={pageData.title}
    description={pageData.description}
    keywords={pageData.keywords}
    type="website"
>
    <!-- Schema.org Service données structurées -->
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Service",
            "@id": "https://prix-site-internet.fr/services",
            "name": "Calculateur Prix Site Internet",
            "description": "Outil en ligne pour estimer le prix de création de votre site internet. Devis personnalisé et gratuit pour tous projets web.",
            "url": "https://prix-site-internet.fr/services",
            "provider": {
                "@type": "Person",
                "name": "Yann Metier",
                "jobTitle": "Développeur Web Freelance"
            },
            "offers": [
                {
                    "@type": "Offer",
                    "name": "Site Responsive Mobile",
                    "price": "0",
                    "priceCurrency": "EUR",
                    "description": "Site adapté mobile et tablette - Inclus"
                },
                {
                    "@type": "Offer",
                    "name": "Référencement Google",
                    "price": "0",
                    "priceCurrency": "EUR",
                    "description": "Référencement Google de base - Inclus"
                },
                {
                    "@type": "Offer",
                    "name": "Design IA Personnalisé",
                    "price": "0",
                    "priceCurrency": "EUR",
                    "description": "2 propositions de design selon vos préférences - Inclus"
                },
                {
                    "@type": "Offer",
                    "name": "Statistiques Détaillées",
                    "price": "100",
                    "priceCurrency": "EUR",
                    "description": "Analytics et statistiques de trafics avancées"
                },
                {
                    "@type": "Offer",
                    "name": "Newsletter Automatique",
                    "price": "100",
                    "priceCurrency": "EUR",
                    "description": "Système d'envoi emails + 8€/mois"
                },
                {
                    "@type": "Offer",
                    "name": "Site Multilingue",
                    "price": "200",
                    "priceCurrency": "EUR",
                    "description": "Site disponible en plusieurs langues"
                },
                {
                    "@type": "Offer",
                    "name": "Paiement Sécurisé",
                    "price": "600",
                    "priceCurrency": "EUR",
                    "description": "Intégration paiement en ligne sécurisé"
                }
                {
                    "@type": "Offer",
                    "name": "Design professionnel",
                    "price": "1500",
                    "priceCurrency": "EUR",
                    "description": "Design du site sur mesure"
                }
            ],
            "areaServed": {
                "@type": "Country",
                "name": "France"
            }
        }
    </script>
    <!-- Hero Section -->
    <section class="pt-20" aria-labelledby="services-hero-heading">
        <header class="text-center mb-12" role="banner">
            <h1
                id="services-hero-heading"
                class="font-bold text-4xl md:text-5xl text-foreground mb-6 leading-tight"
            >
                Estimez le prix de votre site internet
            </h1>
            <p
                class="text-muted-foreground text-xl max-w-2xl mx-auto leading-relaxed"
            >
                Obtenez une estimation rapide en quelques clics. Demandez un
                devis gratuit, personnalisé et détaillé à la suite d'une prise
                de contact.
            </p>
        </header>
    </section>

    <!-- Quote Form Section -->
    <section class="pb-20" aria-labelledby="quote-configurator-heading">
        <article
            class="border border-border/20 rounded-3xl bg-card/60 backdrop-blur-lg overflow-hidden"
        >
            <header class="p-8 pb-6 border-b border-border/20">
                <h2
                    id="quote-configurator-heading"
                    class="text-2xl font-bold text-foreground mb-2 flex items-center gap-4"
                >
                    <CalculatorIcon className="w-8 h-8 text-primary" />
                    Configurateur de devis
                </h2>
                <p class="text-muted-foreground">
                    Sélectionnez vos options pour obtenir une estimation
                    approximative
                </p>
            </header>

            <div class="p-8 space-y-6">
                <!-- Features -->
                <section>
                    <h3 class="text-lg font-semibold text-foreground mb-4">
                        Fonctionnalités souhaitées
                    </h3>
                    <fieldset class="space-y-4">
                        <legend class="sr-only">
                            Sélectionnez les fonctionnalités pour votre site
                        </legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {
                                features.map((feature) => (
                                    <label class="flex items-start space-x-4 p-4 border border-border/20 rounded-xl hover:bg-muted/50 transition-colors cursor-pointer min-h-[100px]">
                                        <input
                                            type="checkbox"
                                            name="features"
                                            value={feature.id}
                                            data-price={feature.price}
                                            checked={feature.included}
                                            disabled={feature.included}
                                            class="w-5 h-5 mt-1 text-primary border-border focus:ring-primary focus:ring-2 disabled:opacity-50"
                                        />
                                        <div class="flex-1 space-y-2">
                                            <div class="text-base font-medium text-foreground leading-relaxed">
                                                {feature.label}
                                            </div>
                                            <div class="flex flex-wrap gap-2">
                                                {feature.included && (
                                                    <span class="inline-flex items-center px-3 py-1 text-sm font-medium text-primary bg-primary/10 rounded-full">
                                                        Inclus
                                                    </span>
                                                )}
                                                {!feature.included &&
                                                    feature.price > 0 && (
                                                        <span class="inline-flex items-center px-3 py-1 text-sm text-foreground bg-gray-200 rounded-full">
                                                            + {feature.price}€
                                                        </span>
                                                    )}
                                                {feature.special && (
                                                    <span class="inline-flex items-center px-3 py-1 text-sm text-blue-700 bg-blue-100 rounded-full">
                                                        {feature.special}
                                                    </span>
                                                )}
                                                {feature.subscription && (
                                                    <span class="inline-flex items-center px-3 py-1 text-sm font-medium text-orange-700 bg-orange-100 rounded-full">
                                                        + {feature.subscription}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    </label>
                                ))
                            }
                        </div>
                    </fieldset>
                </section>

                <!-- Price Display -->
                <section>
                    <h3 class="text-lg font-semibold text-foreground mb-4">
                        Estimation du coût
                    </h3>
                    <div
                        id="price-display"
                        class="p-4 bg-white rounded-lg"
                        aria-live="polite"
                        aria-atomic="true"
                    >
                        <p
                            class="font-semibold text-foreground text-lg text-center"
                        >
                            Estimation totale :
                        </p>

                        <p
                            class="text-xs text-muted-foreground mt-1 text-center"
                        >
                            Prix de base + options sélectionnées
                        </p>
                        <p
                            class="text-4xl font-extrabold text-primary text-center mt-3"
                            id="total-price"
                        >
                            700€
                        </p>
                        <p
                            class="text-xs text-orange-600 font-medium text-center mt-2"
                        >
                            Estimation approximative - Le prix peut être plus
                            cher selon l'ampleur du projet
                        </p>
                    </div>
                </section>

                <!-- Contact Form -->
                <section>
                    <h3 class="text-lg font-semibold text-foreground mb-4">
                        Demander un devis personnalisé
                    </h3>
                    <form class="space-y-4" id="quote-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label
                                    for="name"
                                    class="text-sm font-medium text-foreground inline-block"
                                    >Nom complet *</label
                                >
                                <input
                                    type="text"
                                    id="name"
                                    name="name"
                                    required
                                    placeholder="Votre nom"
                                    aria-describedby="name-error"
                                    class="w-full px-4 py-3 border border-border/20 rounded-xl bg-background/50 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                />
                                <div
                                    id="name-error"
                                    class="text-red-600 text-xs mt-1 hidden"
                                    role="alert"
                                >
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label
                                    for="email"
                                    class="text-sm font-medium text-foreground inline-block"
                                    >Email *</label
                                >
                                <input
                                    type="email"
                                    id="email"
                                    name="email"
                                    required
                                    placeholder="votre@email.com"
                                    aria-describedby="email-error"
                                    class="w-full px-4 py-3 border border-border/20 rounded-xl bg-background/50 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                />
                                <div
                                    id="email-error"
                                    class="text-red-600 text-xs mt-1 hidden"
                                    role="alert"
                                >
                                </div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label
                                for="company"
                                class="text-sm font-medium text-foreground inline-block"
                                >Entreprise (optionnel)</label
                            >
                            <input
                                type="text"
                                id="company"
                                name="company"
                                placeholder="Nom de votre entreprise"
                                class="w-full px-4 py-3 border border-border/20 rounded-xl bg-background/50 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            />
                        </div>

                        <button
                            type="submit"
                            id="submit-btn"
                            aria-describedby="submit-help"
                            class="w-full mt-6 inline-flex items-center justify-center px-6 py-4 bg-primary text-primary-foreground rounded-xl font-medium text-lg hover:bg-primary/90 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed relative overflow-hidden"
                            disabled
                        >
                            <span id="btn-text"
                                >Être contacté pour recevoir un devis détaillé</span
                            >
                            <svg
                                id="btn-arrow"
                                class="ml-2 h-4 w-4 transition-transform duration-300"
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <path d="M5 12h14"></path>
                                <path d="m12 5 7 7-7 7"></path>
                            </svg>
                            <!-- Loading spinner (hidden by default) -->
                            <svg
                                id="btn-spinner"
                                class="ml-2 h-4 w-4 animate-spin hidden"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <circle
                                    class="opacity-25"
                                    cx="12"
                                    cy="12"
                                    r="10"
                                    stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path
                                    class="opacity-75"
                                    fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                ></path>
                            </svg>
                            <!-- Success checkmark (hidden by default) -->
                            <svg
                                id="btn-success"
                                class="ml-2 h-4 w-4 hidden"
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <path d="M20 6L9 17l-5-5"></path>
                            </svg>
                        </button>

                        <div
                            class="text-xs text-muted-foreground text-center space-y-2"
                        >
                            <p id="submit-help" class="font-semibold">
                                Veuillez remplir votre nom et email pour être
                                contacté
                            </p>
                            <p class="italic">
                                En soumettant ce formulaire, vous acceptez
                                d'être contacté par email pour recevoir votre
                                devis personnalisé.
                            </p>
                        </div>
                    </form>
                </section>
            </div>
        </article>
    </section>
</Layout>

<script>
    // Form handling and price calculation
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("quote-form");
        const featureInputs = document.querySelectorAll(
            'input[name="features"]',
        );
        const submitBtn = document.getElementById("submit-btn");
        const nameInput = document.getElementById("name");
        const emailInput = document.getElementById("email");
        // const priceDisplay = document.getElementById("price-display");
        const totalPriceElement = document.getElementById("total-price");

        // Update price calculation
        function updatePrice() {
            const selectedFeatures = document.querySelectorAll(
                'input[name="features"]:checked:not([disabled])',
            );

            const basePrice = 700;
            let featuresPrice = 0;

            selectedFeatures.forEach((feature) => {
                featuresPrice += parseInt(feature.dataset.price || "0");
            });

            const totalPrice = basePrice + featuresPrice;

            // Update price display with announcement for screen readers
            totalPriceElement.textContent = totalPrice.toLocaleString() + "€";

            // Announce price change to screen readers
            const announcement = `Prix mis à jour: ${totalPrice.toLocaleString()} euros`;
            totalPriceElement.setAttribute("aria-label", announcement);

            updateSubmitButton();
        }

        // Update submit button state
        function updateSubmitButton() {
            const hasName = nameInput.value.trim() !== "";
            const hasEmail = emailInput.value.trim() !== "";
            const submitHelp = document.getElementById("submit-help");

            if (hasName && hasEmail) {
                submitBtn.disabled = false;
                submitHelp.textContent = "Formulaire prêt à être envoyé";
            } else {
                submitBtn.disabled = true;
                submitHelp.textContent =
                    "Veuillez remplir votre nom et email pour être contacté";
            }
        }

        // Form validation
        function validateField(field, errorElement, errorMessage) {
            if (!field.value.trim()) {
                errorElement.textContent = errorMessage;
                errorElement.classList.remove("hidden");
                field.setAttribute("aria-invalid", "true");
                return false;
            } else {
                errorElement.textContent = "";
                errorElement.classList.add("hidden");
                field.removeAttribute("aria-invalid");
                return true;
            }
        }

        // Add event listeners
        featureInputs.forEach((input) => {
            input.addEventListener("change", updatePrice);
        });

        nameInput.addEventListener("input", updateSubmitButton);
        emailInput.addEventListener("input", updateSubmitButton);

        // Add validation on blur
        nameInput.addEventListener("blur", function () {
            const nameError = document.getElementById("name-error");
            validateField(nameInput, nameError, "Le nom est requis");
        });

        emailInput.addEventListener("blur", function () {
            const emailError = document.getElementById("email-error");
            const isValid = validateField(
                emailInput,
                emailError,
                "L'email est requis",
            );
            if (isValid && emailInput.value.trim()) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(emailInput.value)) {
                    emailError.textContent = "Format d'email invalide";
                    emailError.classList.remove("hidden");
                    emailInput.setAttribute("aria-invalid", "true");
                }
            }
        });

        // Button animation functions
        function showLoadingState() {
            const btnText = document.getElementById("btn-text");
            const btnArrow = document.getElementById("btn-arrow");
            const btnSpinner = document.getElementById("btn-spinner");

            btnText.textContent = "Envoi en cours...";
            btnArrow.classList.add("hidden");
            btnSpinner.classList.remove("hidden");
            submitBtn.disabled = true;
        }

        function showSuccessState() {
            const btnText = document.getElementById("btn-text");
            const btnSpinner = document.getElementById("btn-spinner");
            const btnSuccess = document.getElementById("btn-success");

            btnText.textContent = "Demande de devis envoyé avec succès !";
            btnSpinner.classList.add("hidden");
            btnSuccess.classList.remove("hidden");
            submitBtn.classList.remove("bg-primary");
            submitBtn.classList.add("bg-green-700");
            window.localStorage.setItem("devis", "1");
        }

        function resetButtonState() {
            const btnText = document.getElementById("btn-text");
            const btnArrow = document.getElementById("btn-arrow");
            const btnSpinner = document.getElementById("btn-spinner");
            const btnSuccess = document.getElementById("btn-success");

            btnText.textContent =
                "Être contacté pour recevoir un devis détaillé";
            btnArrow.classList.remove("hidden");
            btnSpinner.classList.add("hidden");
            btnSuccess.classList.add("hidden");
            submitBtn.classList.remove("bg-green-500");
            submitBtn.classList.add("bg-primary");
            submitBtn.disabled = false;
            updateSubmitButton(); // Re-check if form is valid
        }

        // Handle form submission
        if (form) {
            form.addEventListener("submit", async function (e) {
                e.preventDefault();

                // Validate all fields
                const nameError = document.getElementById("name-error");
                const emailError = document.getElementById("email-error");

                const isNameValid = validateField(
                    nameInput,
                    nameError,
                    "Le nom est requis",
                );
                const isEmailValid = validateField(
                    emailInput,
                    emailError,
                    "L'email est requis",
                );

                if (!isNameValid || !isEmailValid) {
                    return;
                }

                // Show loading animation
                showLoadingState();

                // Prepare JSON data
                const selectedFeatures = Array.from(
                    document.querySelectorAll('input[name="features"]:checked'),
                ).map((input) => input.value);

                const jsonData = {
                    name: nameInput.value.trim(),
                    email: emailInput.value.trim(),
                    company: document.getElementById("company").value.trim(),
                    features: selectedFeatures,
                    totalPrice: document.getElementById("total-price").textContent,
                    timestamp: new Date().toISOString()
                };

                try {
                    // Simulate form submission delay
                    if (window.localStorage.getItem("devis") == "1") {
                        await new Promise((resolve) =>
                            setTimeout(resolve, 1000),
                        );
                        showSuccessState();
                    } else {
                        await new Promise((resolve) =>
                            setTimeout(resolve, 500),
                        );

                        await fetch("https://api-routes-one-nu.vercel.app/api/mail", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(jsonData),
                        });

                        // Show success state
                        showSuccessState();
                    }
                } catch (error) {
                    console.error("Erreur lors de l'envoi:", error);
                    resetButtonState();
                }
            });
        }

        // Initialize
        updatePrice();
        updateSubmitButton();
    });
</script>
